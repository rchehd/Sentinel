services:
  # ========================================
  # Caddy reverse proxy (gateway)
  # ========================================
  caddy:
    build:
      context: .
      dockerfile: docker/caddy/Dockerfile
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    environment:
      DOMAIN: ${DOMAIN:-sentinel.localhost}
    volumes:
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - api
      - web

  # ========================================
  # Symfony API (FrankenPHP)
  # ========================================
  api:
    build:
      context: .
      dockerfile: docker/api/Dockerfile
      target: prod
    depends_on:
      database:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    environment:
      APP_ENV: ${APP_ENV:-dev}
      APP_SECRET: ${APP_SECRET:-!ChangeMe!}
      DATABASE_URL: postgresql://${POSTGRES_USER:-app}:${POSTGRES_PASSWORD:-!ChangeMe!}@database:5432/${POSTGRES_DB:-app}?serverVersion=${POSTGRES_VERSION:-16}&charset=${POSTGRES_CHARSET:-utf8}
      REDIS_URL: redis://redis:6379
      MESSENGER_TRANSPORT_DSN: redis://redis:6379/messages
      MERCURE_URL: ${MERCURE_URL:-http://api/.well-known/mercure}
      MERCURE_PUBLIC_URL: ${MERCURE_PUBLIC_URL:-https://api.sentinel.localhost/.well-known/mercure}
      MERCURE_JWT_SECRET: ${MERCURE_JWT_SECRET:-!ChangeThisMercureHubJWTSecretKey!}
      CORS_ALLOW_ORIGIN: ${CORS_ALLOW_ORIGIN:-https://sentinel.localhost}
      SERVER_NAME: ${SERVER_NAME:-:80}
      FRANKENPHP_CONFIG: "worker ./public/index.php"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ========================================
  # Messenger Worker (async jobs)
  # ========================================
  worker:
    build:
      context: .
      dockerfile: docker/api/Dockerfile
      target: prod
    restart: unless-stopped
    command: php bin/console messenger:consume async failed --time-limit=3600 --memory-limit=256M -vv
    depends_on:
      database:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      APP_ENV: ${APP_ENV:-dev}
      APP_SECRET: ${APP_SECRET:-!ChangeMe!}
      DATABASE_URL: postgresql://${POSTGRES_USER:-app}:${POSTGRES_PASSWORD:-!ChangeMe!}@database:5432/${POSTGRES_DB:-app}?serverVersion=${POSTGRES_VERSION:-16}&charset=${POSTGRES_CHARSET:-utf8}
      REDIS_URL: redis://redis:6379
      MESSENGER_TRANSPORT_DSN: redis://redis:6379/messages
      MERCURE_URL: ${MERCURE_URL:-http://api/.well-known/mercure}
      MERCURE_JWT_SECRET: ${MERCURE_JWT_SECRET:-!ChangeThisMercureHubJWTSecretKey!}

  # ========================================
  # React Frontend
  # ========================================
  web:
    build:
      context: .
      dockerfile: docker/web/Dockerfile
    restart: unless-stopped

  # ========================================
  # PostgreSQL
  # ========================================
  database:
    image: pgvector/pgvector:pg16
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-app}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-!ChangeMe!}
      POSTGRES_USER: ${POSTGRES_USER:-app}
    volumes:
      - database_data:/var/lib/postgresql/data
      - ./docker/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "${POSTGRES_USER:-app}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ========================================
  # Redis (cache + queue)
  # ========================================
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  caddy_data:
  caddy_config:
  database_data:
  redis_data:
